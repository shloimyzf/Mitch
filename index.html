<!DOCTYPE html>
<html lang="en" style="color-scheme: light;">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Mitch's Coffee</title>
  
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#E2CB9F">

  <link rel="apple-touch-icon" href="icon.png">
  <link rel="icon" type="image/png" href="icon.png">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  
  <script type="text/javascript">
    (function(){ emailjs.init("X_5xpqldnPZM4GwJh"); })();
  </script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
    :root { color-scheme: light; }
    body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; background-color: #E2CB9F; color: #432818; }
    .animate-in { animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .modal-enter { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    .menu-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; }
    .menu-card { aspect-ratio: 1 / 1; display: flex; flex-direction: column; justify-content: flex-end; background-size: cover; background-position: center; position: relative; overflow: hidden; }
    .menu-card::after { content: ''; position: absolute; inset: 0; background: linear-gradient(to top, rgba(226, 203, 159, 1) 0%, rgba(226, 203, 159, 0.7) 35%, rgba(0,0,0,0) 100%); z-index: 1; }
    .btn-disabled { opacity: 0.5; pointer-events: none; filter: grayscale(1); }
  </style>
</head>
<body class="select-none pb-32">

<script>
    window.onerror = function(msg, url, line) {
        if(!msg.includes("ResizeObserver")) {
             // alert("ERROR:\n" + msg + "\nLine: " + line); // Uncomment if you need to debug
        }
    };
</script>

<div id="main-view">
  <div class="min-h-screen flex flex-col items-center justify-center gap-4">
    <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-[#432818]"></div>
    <p class="text-[#432818] text-sm font-black uppercase tracking-widest">Brewing...</p>
  </div>
</div>

<div id="modal-layer" class="fixed inset-0 z-50 pointer-events-none flex items-end sm:items-center justify-center"></div>
<div id="toast-layer" class="fixed top-4 left-4 right-4 z-[60] pointer-events-none"></div>

<script type="module">
  // CHANGED: Using version 10.7.1 to match your sw.js file
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot, doc, setDoc, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCMcxuH-8Pc0t8eC71xOU8TXLu0ZoF-RG4",
    authDomain: "mitches-coffee.firebaseapp.com",
    projectId: "mitches-coffee",
    storageBucket: "mitches-coffee.firebasestorage.app",
    messagingSenderId: "789709713646",
    appId: "1:789709713646:web:3f09ce026b40a85b3f03ff"
  };

  const VAPID_KEY = "BF3iJzRgdcJq3LAFW2cO5_5m-dGyzGhS74-_G4ty6O9lzftV92_inFFBP9ThuDAZ7FJd2V27VvNFgJsyOk8lzg4";
  
  const appId = "mitchs-coffee";
  const EMAIL_SERVICE_ID = "service_m3qf2td";
  const EMAIL_TEMPLATE_ID = "template_c7bbquk"; 
  const ADMIN_CONTACTS = ["Rybdpm@gmail.com"];
  
  let db, auth, messaging;
  let deferredPrompt;
  let state = {
    user: null, deviceId: null, isLoggedIn: false,
    customerName: "", customerEmail: "",
    dormRoom: "", orders: [], cart: [], isDelivery: true,
    settings: { deliveryEnabled: true, shopOpen: true, outOfStock: [] },
    modal: { isOpen: false, item: null, size: null, syrup: null, pumps: 0, milk: 'Regular' },
    showInstall: false, fcmToken: null
  };

  const MENU_ITEMS = [
    { id: 'hot-latte', name: 'Regular Hot Latte', category: 'Lattes', type: 'drink', image: 'hot-latte.png' },
    { id: 'iced-latte', name: 'Regular Iced Latte', category: 'Lattes', type: 'drink', image: 'iced-latte.png' },
    { id: 'vanilla-hot-latte', name: 'Vanilla Hot Latte', category: 'Lattes', type: 'drink', image: 'hot-latte.png' },
    { id: 'vanilla-iced-latte', name: 'Vanilla Iced Latte', category: 'Lattes', type: 'drink', image: 'iced-latte.png' },
    { id: 'brown-sugar-hot', name: 'Brown Sugar Hot Latte', category: 'Lattes', type: 'drink', image: 'hot-latte.png' },
    { id: 'brown-sugar-iced', name: 'Brown Sugar Iced Latte', category: 'Lattes', type: 'drink', image: 'iced-latte.png' },
    { id: 'hot-cocoa', name: 'Regular Hot Cocoa', category: 'Hot Cocoa', type: 'drink', image: 'hot-chocolate.png' },
    { id: 'pizza-snaps', name: 'Pizza Snaps (4)', category: 'Food', type: 'food', image: 'pizza.png' },
    { id: 'cookie', name: 'Regular Cookie', category: 'Food', type: 'cookie', image: 'cookie.png' },
    { id: 'choc-chip', name: 'Jumbo Cookie', category: 'Food', type: 'cookie', image: 'jumbo-cookie.png' },
    { id: 'pareve-cookie', name: 'Jumbo (Pareve)', category: 'Food', type: 'cookie', image: 'jumbo-cookie.png' },
  ];

  const CATEGORIES = ['Lattes', 'Hot Cocoa', 'Food'];

  async function init() {
    setupIdentity();
    window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; state.showInstall = true; renderMain(); });
    
    const app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    auth = getAuth(app);
    messaging = getMessaging(app);

    // Register Service Worker
    if ('serviceWorker' in navigator) {
        try {
            const reg = await navigator.serviceWorker.register('sw.js');
            console.log("Service Worker Registered:", reg);
        } catch (err) {
            console.error("SW Registration Failed:", err);
        }
    }

    await signInAnonymously(auth);
    onAuthStateChanged(auth, user => {
      state.user = user;
      if (user) { 
          listenOrders(); 
          listenSettings(); 
          if(Notification.permission === 'granted') requestPushPermission(true); 
      }
      renderMain();
    });

    onMessage(messaging, (payload) => { 
        showToast(`üîî ${payload.notification.title}: ${payload.notification.body}`); 
    });
    
    setInterval(() => { if(state.isLoggedIn) renderMain(); }, 15000); 
  }

  // --- THE FIX IS HERE (Updated to use sw.js explicitly) ---
  window.requestPushPermission = async (silent = false) => {
    try {
        if (!silent) {
            const permission = await Notification.requestPermission();
            if (permission !== 'granted') return showToast("Permission Denied");
        }
        
        // 1. Get the registration we already made
        const registration = await navigator.serviceWorker.getRegistration();

        // 2. Pass it to Firebase so it uses sw.js instead of looking for the missing file
        const token = await getToken(messaging, { 
            vapidKey: VAPID_KEY,
            serviceWorkerRegistration: registration 
        });
        
        if (token) {
            state.fcmToken = token;
            console.log("FCM Token:", token);
            if(!silent) showToast("Notifications Enabled! ‚úÖ");
            renderMain();
        } else {
            if(!silent) alert("Error: No Token received from Firebase.");
        }
    } catch (err) {
        console.error("Push Error:", err);
        if(!silent) alert("TECHNICAL ERROR:\n" + err.message);
    }
  };

  function setupIdentity() {
    let storedId = localStorage.getItem('mitch_device_id');
    if (!storedId) { storedId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9); localStorage.setItem('mitch_device_id', storedId); }
    state.deviceId = storedId;
    const storedName = localStorage.getItem('mitch_customer_name');
    const storedEmail = localStorage.getItem('mitch_customer_email');
    if (storedName && storedEmail) { state.customerName = storedName; state.customerEmail = storedEmail; state.isLoggedIn = true; }
  }

  function listenOrders() {
    onSnapshot(collection(db, "artifacts", appId, "public", "data", "orders"), snap => {
      state.orders = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
      renderMain();
    });
  }

  function listenSettings() {
      onSnapshot(doc(db, "artifacts", appId, "public", "data", "settings", "global"), (docSnap) => {
          if (docSnap.exists()) {
              state.settings = { outOfStock: [], ...docSnap.data() };
              if (!state.settings.deliveryEnabled && state.isDelivery) { state.isDelivery = false; state.dormRoom = ""; }
              renderMain();
          }
      });
  }

  window.installPwa = async () => { if (!deferredPrompt) return; deferredPrompt.prompt(); const { outcome } = await deferredPrompt.userChoice; if (outcome === 'accepted') state.showInstall = false; deferredPrompt = null; renderMain(); };

  window.getPrice = (itemId, size, milk) => {
    let base = 0;
    if (itemId === 'hot-cocoa') base = size === 'Small' ? 3.50 : 4.00;
    else if (itemId === 'cookie') base = 1.00;
    else if (itemId === 'choc-chip' || itemId === 'pareve-cookie') base = 2.00;
    else if (itemId === 'pizza-snaps') base = 2.00;
    else base = size === 'Small' ? 4.00 : 5.00; 
    if (milk === 'Oat') base += 1.00;
    return base;
  }

  window.login = e => { e.preventDefault(); const name = document.getElementById("loginName").value.trim(); const email = document.getElementById("loginEmail").value.trim(); if (!name || !email) return alert("Name and Email Required!"); state.customerName = name; state.customerEmail = email; state.isLoggedIn = true; localStorage.setItem('mitch_customer_name', name); localStorage.setItem('mitch_customer_email', email); requestPushPermission(); renderMain(); };
  window.logout = () => { localStorage.clear(); location.reload(); };
  window.updateRoom = (val) => { state.dormRoom = val; };
  window.setDelivery = v => { state.isDelivery = v; if(!v) state.dormRoom = ""; renderMain(); };
  
  window.cancelOrder = async (id) => {
      if(!confirm("Cancel this order?")) return;
      try { await deleteDoc(doc(db, "artifacts", appId, "public", "data", "orders", id)); showToast("Order Cancelled"); } catch(e) { console.error(e); }
  };

  window.openModal = (id) => {
      if (!state.settings.shopOpen) return showToast("Shop is Closed!");
      const item = MENU_ITEMS.find(i => i.id === id);
      let size = 'Large'; let pumps = 4; let syrup = null; let milk = 'Regular';
      if (item.name.toLowerCase().includes('vanilla')) syrup = 'Vanilla'; 
      else if (item.name.toLowerCase().includes('brown sugar')) syrup = 'Brown Sugar';
      else if (item.name.toLowerCase().includes('regular') && item.category === 'Lattes') { syrup = null; pumps = 0; } else { syrup = 'None'; pumps = 0; }
      state.modal = { isOpen: true, item, size, syrup, pumps, milk };
      renderModal();
  };

  window.closeModal = () => { state.modal.isOpen = false; renderModal(); setTimeout(() => { state.modal.item = null; }, 200); };
  
  window.updateModalState = (key, value) => {
      state.modal[key] = value;
      if (key === 'size' && state.modal.syrup && state.modal.syrup !== 'None') state.modal.pumps = (value === 'Small') ? 3 : 4;
      if (key === 'syrup') state.modal.pumps = (value === 'None') ? 0 : (state.modal.size === 'Small' ? 3 : 4);
      renderModal();
  };

  window.changeModalPumps = (d) => { state.modal.pumps = Math.max(0, Math.min(8, state.modal.pumps + d)); renderModal(); };

  window.addToCartFromModal = () => {
      const { item, size, syrup, pumps, milk } = state.modal;
      const price = getPrice(item.id, size, milk);
      const existing = state.cart.find(c => c.id === item.id && c.size === size && c.syrupType === syrup && c.syrupPumps === pumps && c.milk === milk);
      if (existing) existing.qty++; else state.cart.push({ ...item, size, price, syrupType: syrup, syrupPumps: pumps, milk, qty: 1 });
      state.modal.isOpen = false; renderModal(); renderMain(); 
  };

  window.removeCart = idx => { if (state.cart[idx].qty > 1) state.cart[idx].qty--; else state.cart.splice(idx, 1); renderMain(); };
  window.addCartQty = idx => { state.cart[idx].qty++; renderMain(); };

  window.order = async () => {
    if (!state.cart.length) return showToast("Cart is empty!");
    if (state.isDelivery && !state.dormRoom) return showToast("Room # required for Delivery!");
    sendTextToAdmin(state.customerName, state.dormRoom);
    try {
      await addDoc(collection(db, "artifacts", appId, "public", "data", "orders"), {
        customerName: state.customerName, 
        customerEmail: state.customerEmail,
        dormRoom: state.dormRoom, 
        items: state.cart, 
        total: state.cart.reduce((s, i) => s + (i.price * i.qty), 0),
        isDelivery: state.isDelivery, 
        status: "pending", 
        timestamp: serverTimestamp(), 
        userId: state.user.uid, 
        deviceId: state.deviceId, 
        fcmToken: state.fcmToken 
      });
      state.cart = []; state.isDelivery = true; state.dormRoom = ""; 
      showToast("Order Sent!");
      renderMain();
    } catch(e) { showToast("Error sending order!"); console.error(e); }
  };
  
  function sendTextToAdmin(name, room) {
    const message = `NEW ORDER: ${name} ${room ? 'in Room ' + room : '(Pickup)'}`;
    ADMIN_CONTACTS.forEach(contact => { emailjs.send(EMAIL_SERVICE_ID, EMAIL_TEMPLATE_ID, { to_email: contact, name: name, email: "noreply@mitchscoffee.com", message: message }).catch(err => console.log("Admin Alert Failed", err)); });
  }

  function showToast(m) { const t = document.getElementById("toast-layer"); t.innerHTML = `<div class="animate-bounce bg-[#432818] text-[#E2CB9F] px-6 py-3 rounded-2xl shadow-2xl text-center font-bold border border-[#E2CB9F]/20 mx-auto max-w-xs">${m}</div>`; setTimeout(() => { t.innerHTML = ''; }, 3000); }

  function renderMain() {
    const root = document.getElementById("main-view");
    if(state.modal.isOpen) return;

    if (!state.isLoggedIn) {
        root.innerHTML = `
        <div class="min-h-screen flex items-center justify-center p-4">
            <div class="bg-white/90 backdrop-blur w-full max-w-sm rounded-3xl p-8 shadow-2xl text-center space-y-6 animate-in">
                <div class="bg-[#432818] w-24 h-24 rounded-full flex items-center justify-center mx-auto shadow-lg border-4 border-[#E2CB9F]">
                    <img src="image.png" class="w-16 h-16 rounded-full shadow-sm">
                </div>
                <h1 class="text-4xl font-black text-[#432818] tracking-tight italic">Mitch's Coffee</h1>
                <form onsubmit="login(event)" class="space-y-4 text-left">
                    <input required id="loginName" placeholder="Name" class="w-full bg-[#E2CB9F]/30 border-2 border-[#432818]/20 rounded-2xl px-6 py-4 text-lg outline-none focus:border-[#432818] font-bold text-[#432818] placeholder-[#432818]/50">
                    <input type="email" required id="loginEmail" placeholder="Email (Required)" class="w-full bg-[#E2CB9F]/30 border-2 border-[#432818]/20 rounded-2xl px-6 py-4 text-lg outline-none focus:border-[#432818] font-bold text-[#432818] placeholder-[#432818]/50">
                    <button class="w-full bg-[#432818] text-[#E2CB9F] py-4 rounded-2xl font-bold text-xl shadow-xl active:scale-95 transition-transform uppercase tracking-wider">Start Ordering</button>
                </form>
            </div>
        </div>`;
    } else {
        const now = Date.now();
        const myOrders = state.orders.filter(o => o.deviceId === state.deviceId && o.status !== 'completed' && (now - (o.timestamp?.toMillis() || now) < 3600000));
        
        root.innerHTML = `
            ${state.showInstall ? `<div class="bg-[#432818] text-[#E2CB9F] p-3 flex justify-between items-center sticky top-0 z-50 shadow-md animate-in"><div class="flex items-center gap-3"><img src="icon.png" class="w-8 h-8 rounded-lg bg-white p-0.5"><div><p class="text-xs font-bold">Install App</p></div></div><button onclick="installPwa()" class="bg-[#E2CB9F] text-[#432818] px-3 py-1 rounded-full text-xs font-black uppercase shadow-lg">Install</button></div>` : ''}
            
            <header class="bg-[#E2CB9F]/90 backdrop-blur-md border-b border-[#432818]/10 sticky top-0 z-40 px-4 py-4 flex justify-between items-center shadow-sm">
                <div class="flex items-center gap-3">
                    <img src="image.png" class="w-16 h-16 rounded-full">
                    <h1 class="text-3xl font-black italic text-[#432818] tracking-tighter">Mitch's Coffee</h1>
                </div>
                <button onclick="logout()" class="px-3 py-2 rounded-xl text-xs font-black bg-[#432818]/10 text-[#432818] uppercase hover:bg-[#432818]/20">Log Out</button>
            </header>

            <main class="max-w-md mx-auto p-4 space-y-6 pb-32">
                ${!state.settings.shopOpen ? `<div class="bg-[#432818] text-[#E2CB9F] p-6 rounded-3xl text-center space-y-4 shadow-xl border-4 border-red-500 animate-in"><h2 class="text-3xl font-black italic">Closed!</h2><p class="text-[#E2CB9F]/70 font-bold">Mitch is away right now.</p></div>` : ''}
                
                <button onclick="requestPushPermission()" class="w-full py-2 bg-[#432818]/10 text-[#432818] font-bold uppercase text-[10px] rounded-xl flex items-center justify-center gap-2 active:scale-95 transition-transform"><i data-lucide="bell" class="w-3 h-3"></i> ${state.fcmToken ? 'Notifications Active' : 'Enable Notifications'}</button>

                ${myOrders.map(o => `
                    <section class="bg-white p-6 rounded-[2.5rem] shadow-xl border-4 ${o.status==='ready'?'border-green-500':'border-[#432818]/20'} space-y-5 animate-in relative overflow-hidden">
                        <div class="flex justify-between items-center relative z-10">
                            <h3 class="font-black text-sm uppercase flex items-center gap-2 tracking-widest text-[#432818]">
                                ${o.status==='ready' ? '<i data-lucide="check-circle" class="text-green-500"></i> READY!' : '<i data-lucide="zap" class="animate-pulse text-[#432818]"></i> ' + o.status.toUpperCase()}
                            </h3>
                            <div class="flex gap-2 items-center">
                                ${o.status === 'pending' ? `<button onclick="cancelOrder('${o.id}')" class="bg-red-100 text-red-600 px-2 py-1 rounded-lg text-[9px] font-black uppercase tracking-wider hover:bg-red-200">Cancel</button>` : ''}
                                <span class="text-[10px] font-black bg-[#E2CB9F] text-[#432818] px-2 py-1 rounded">#${o.id.slice(-4)}</span>
                            </div>
                        </div>
                        <div class="flex justify-between items-center bg-[#E2CB9F]/20 p-4 rounded-2xl border border-[#432818]/10"><span class="text-2xl font-black uppercase italic text-[#432818] tracking-tighter">${o.status}</span></div>
                        <div class="relative h-6 rounded-full bg-[#E2CB9F]/50 overflow-hidden shadow-inner"><div class="h-full transition-all duration-1000 ${o.status==='ready'?'bg-green-500':'bg-[#432818]'}" style="width: ${o.status==='pending'?'20%':o.status==='brewing'?'60%':'100%'}"></div></div>
                        <div class="bg-[#E2CB9F]/20 rounded-2xl p-4 space-y-2 border border-[#432818]/10 text-xs">${o.items.map(it => `<div class="flex justify-between font-black text-[#432818]"><span>${it.qty}x ${it.name}</span><span class="opacity-60">${it.size || ''} ${it.milk && it.milk !== 'Regular' ? `(${it.milk})` : ''}</span></div>`).join('')}</div>
                    </section>`).join('')}

                ${state.cart.length ? `
                    <section class="bg-[#432818] text-[#E2CB9F] p-6 rounded-3xl shadow-2xl space-y-5">
                        <h2 class="text-xl font-black flex items-center gap-2 text-[#E2CB9F]"><i data-lucide="shopping-bag" class="w-6 h-6"></i> Basket</h2>
                        ${state.settings.deliveryEnabled ? `
                            <div class="grid grid-cols-2 gap-2 bg-[#E2CB9F]/10 p-1 rounded-2xl border border-[#E2CB9F]/20">
                                <button onclick="setDelivery(false)" class="py-4 rounded-xl text-[10px] font-black uppercase transition-all ${!state.isDelivery ? 'bg-[#E2CB9F] text-[#432818] shadow-lg' : 'text-[#E2CB9F]/50'}">Pickup</button>
                                <button onclick="setDelivery(true)" class="py-4 rounded-xl text-[10px] font-black uppercase transition-all ${state.isDelivery ? 'bg-[#E2CB9F] text-[#432818] shadow-lg' : 'text-[#E2CB9F]/50'}">Delivery (Free)</button>
                            </div>` 
                            : '<div class="text-center text-xs font-bold uppercase opacity-50">Pickup Only</div>'}
                        <div class="space-y-3 px-1">
                            ${state.cart.map((item, idx) => `
                                <div class="flex items-center justify-between text-sm">
                                    <div class="flex flex-col"><span class="font-bold">${item.qty}x ${item.name}</span><span class="text-[10px] opacity-70 font-bold uppercase">${item.size || ''} ${item.syrupType!=='None' && item.syrupType ? `/ ${item.syrupPumps} ${item.syrupType}` : ''} ${item.milk && item.milk !== 'Regular' ? `(${item.milk})` : ''}</span></div>
                                    <div class="flex items-center gap-2"><button onclick="removeCart(${idx})" class="p-1 bg-[#E2CB9F]/20 rounded-lg"><i data-lucide="minus" class="w-3 h-3"></i></button><button onclick="addCartQty(${idx})" class="p-1 bg-[#E2CB9F] text-[#432818] rounded-lg"><i data-lucide="plus" class="w-3 h-3"></i></button><span class="font-bold ml-2">$${(item.price*item.qty).toFixed(2)}</span></div>
                                </div>`).join('')}
                        </div>
                        ${state.isDelivery ? `<input oninput="updateRoom(this.value)" value="${state.dormRoom}" placeholder="Room # (Required)" class="w-full bg-[#E2CB9F]/10 border-none rounded-2xl px-5 py-4 text-[#E2CB9F] font-black placeholder-[#E2CB9F]/50 outline-none focus:ring-2 focus:ring-[#E2CB9F]/50">` : ''}
                        <button onclick="order()" class="w-full bg-[#E2CB9F] text-[#432818] py-4 rounded-2xl font-black text-xl shadow-lg active:scale-95 transition-transform">Order ‚Ä¢ $${(state.cart.reduce((s, i) => s + (i.price * i.qty), 0)).toFixed(2)}</button>
                    </section>` : ''}

                ${CATEGORIES.map(cat => `
                    <section class="space-y-4">
                        <h2 class="text-2xl font-black border-b-4 border-[#432818]/20 pb-2 uppercase tracking-tight italic text-[#432818]">${cat}</h2>
                        <div class="menu-grid">
                            ${MENU_ITEMS.filter(i => i.category === cat).map(item => {
                                const isOutOfStock = state.settings.outOfStock && state.settings.outOfStock.includes(item.id);
                                let priceDisplay = '$2.00'; 
                                if (item.type === 'drink') priceDisplay = `$${getPrice(item.id, 'Small', 'Regular').toFixed(2)} / $${getPrice(item.id, 'Large', 'Regular').toFixed(2)}`;
                                else if (item.id === 'cookie') priceDisplay = '$1.00';
                                
                                return `
                                <button onclick="${isOutOfStock ? '' : `openModal('${item.id}')`}" class="${isOutOfStock ? 'opacity-50 grayscale cursor-not-allowed' : 'active:scale-[0.95] hover:shadow-xl'} bg-[#432818] rounded-[1.5rem] border shadow-md p-4 menu-card transition group text-left relative overflow-hidden" style="background-image: url('${item.image}');">
                                    <div class="flex flex-col items-start gap-1 z-10 w-full h-full justify-between">
                                        <div>
                                            <h3 class="font-black text-[#432818] text-lg leading-tight drop-shadow-md mb-1 pb-2">${item.name}</h3>
                                            ${item.id==='choc-chip' ? '<span class="text-[10px] font-black bg-[#E2CB9F] text-[#432818] px-2 py-0.5 rounded uppercase inline-block shadow-sm">‚ö†Ô∏è DAIRY</span>' : ''}
                                            ${item.id==='pareve-cookie' ? '<span class="text-[10px] font-black bg-[#E2CB9F] text-[#432818] px-2 py-0.5 rounded uppercase inline-block shadow-sm">PAREVE</span>' : ''}
                                        </div>
                                        <div class="flex w-full justify-between items-end">
                                            <div class="text-[#432818] font-black bg-[#E2CB9F]/90 px-3 py-2 rounded-xl text-[10px] backdrop-blur-md shadow-sm">
                                                ${isOutOfStock ? 'SOLD OUT' : priceDisplay}
                                            </div>
                                            <div class="bg-[#E2CB9F]/90 p-2 rounded-full backdrop-blur-md shadow-sm">
                                                <i data-lucide="${isOutOfStock ? 'ban' : 'plus'}" class="w-5 h-5 text-[#432818]"></i>
                                            </div>
                                        </div>
                                    </div>
                                </button>`;
                            }).join('')}
                        </div>
                    </section>`).join('')}
            </main>`;
        lucide.createIcons();
    }
  }

  function renderModal() {
      const container = document.getElementById("modal-layer");
      const { isOpen, item, size, syrup, pumps, milk } = state.modal;
      
      if (!isOpen || !item) { container.innerHTML = ''; container.style.pointerEvents = 'none'; return; }
      container.style.pointerEvents = 'auto';
      
      const existingModal = document.getElementById('modal-card');
      const shouldHavePumps = syrup && syrup !== 'None';
      const hasPumpsContainer = document.getElementById('pumps-container');
      const needsStructuralChange = (!!hasPumpsContainer) !== shouldHavePumps;

      if (existingModal && !needsStructuralChange) {
          const priceEl = document.getElementById('modal-price');
          if(priceEl) priceEl.innerText = `$${(item.type==='drink' ? getPrice(item.id, size, milk) : getPrice(item.id)).toFixed(2)}`;
          const pumpsEl = document.getElementById('modal-pumps');
          if(pumpsEl) pumpsEl.innerText = pumps;
          
          document.querySelectorAll('.size-btn').forEach(btn => btn.className = `flex-1 py-4 rounded-xl text-sm font-black transition-all size-btn ${btn.dataset.size === size ? 'bg-[#432818] text-[#E2CB9F] shadow-lg' : 'opacity-50'}`);
          document.querySelectorAll('.syrup-btn').forEach(btn => btn.className = `flex-1 py-4 rounded-xl text-sm font-black transition-all syrup-btn ${btn.dataset.syrup === syrup ? 'bg-[#432818] text-[#E2CB9F] shadow-lg' : 'opacity-50'}`);
          document.querySelectorAll('.milk-btn').forEach(btn => btn.className = `flex-1 py-4 rounded-xl text-sm font-black transition-all milk-btn ${btn.dataset.milk === milk ? 'bg-[#432818] text-[#E2CB9F] shadow-lg' : 'opacity-50'}`);

          const addBtn = document.getElementById('modal-add-btn');
          const isRegLatte = item.name.includes('Regular') && item.category === 'Lattes';
          const isDisabled = isRegLatte && !syrup;
          if (addBtn) {
              addBtn.disabled = isDisabled;
              addBtn.innerText = isDisabled ? 'Select Flavor' : 'Add to Order';
              addBtn.className = `w-full bg-[#432818] text-[#E2CB9F] py-5 rounded-2xl font-black text-xl shadow-xl active:scale-95 transition-all ${isDisabled ? 'btn-disabled' : ''}`;
          }
          return; 
      }

      let syrupName = 'Classic'; 
      if (item.name.includes('Vanilla')) syrupName = 'Vanilla'; 
      if (item.name.includes('Brown Sugar')) syrupName = 'Brown Sugar';
      
      const isDrink = item.type === 'drink';
      const isRegLatte = item.name.includes('Regular') && item.category === 'Lattes';
      const isVanilla = item.name.includes('Vanilla');
      const isDisabled = isRegLatte && !syrup;

      container.innerHTML = `
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeModal()"></div>
        <div id="modal-card" class="bg-[#E2CB9F] text-[#432818] w-full max-w-sm rounded-t-[2rem] sm:rounded-[2rem] p-6 relative z-10 shadow-2xl space-y-6 pb-10 modal-enter">
            <div class="flex justify-between items-start">
                <div>
                    <h2 class="text-3xl font-black leading-tight italic">${item.name}</h2>
                    <p id="modal-price" class="opacity-60 font-bold text-lg">$${(item.type==='drink' ? getPrice(item.id, size, milk) : getPrice(item.id)).toFixed(2)}</p>
                </div>
                <button onclick="closeModal()" class="bg-[#432818]/10 p-2 rounded-full"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            ${isDrink ? `
                <div class="space-y-4">
                     <div>
                         <label class="text-xs font-black opacity-50 uppercase ml-1">Size</label>
                         <div class="bg-[#432818]/10 p-1 rounded-2xl flex mt-1">
                            <button onclick="updateModalState('size', 'Small')" data-size="Small" class="size-btn flex-1 py-4 rounded-xl text-sm font-black transition-all ${size==='Small'?'bg-[#432818] text-[#E2CB9F] shadow-lg':'opacity-50'}">Small</button>
                            <button onclick="updateModalState('size', 'Large')" data-size="Large" class="size-btn flex-1 py-4 rounded-xl text-sm font-black transition-all ${size==='Large'?'bg-[#432818] text-[#E2CB9F] shadow-lg':'opacity-50'}">Large</button>
                         </div>
                    </div>
                    <div>
                         <label class="text-xs font-black opacity-50 uppercase ml-1">Flavor</label>
                         <div class="bg-[#432818]/10 p-1 rounded-2xl flex mt-1">
                            <button onclick="updateModalState('syrup', '${syrupName}')" data-syrup="${syrupName}" class="syrup-btn flex-1 py-4 rounded-xl text-sm font-black transition-all ${syrup===syrupName?'bg-[#432818] text-[#E2CB9F] shadow-lg':'opacity-50'}">${syrupName}</button>
                            ${!isVanilla ? `<button onclick="updateModalState('syrup', 'None')" data-syrup="None" class="syrup-btn flex-1 py-4 rounded-xl text-sm font-black transition-all ${syrup==='None'?'bg-[#432818] text-[#E2CB9F] shadow-lg':'opacity-50'}">No Syrup</button>` : ''}
                         </div>
                    </div>
                    ${syrup && syrup !== 'None' ? `
                        <div class="animate-in" id="pumps-container">
                            <label class="text-xs font-black opacity-50 uppercase ml-1">Pumps</label>
                            <div class="flex items-center justify-between bg-[#432818]/5 border-2 border-[#432818]/10 p-2 rounded-2xl mt-1">
                                <button onclick="changeModalPumps(-1)" class="w-12 h-12 bg-[#E2CB9F] rounded-xl shadow-sm border border-[#432818]/20 flex items-center justify-center"><i data-lucide="minus" class="w-5 h-5 opacity-50"></i></button>
                                <span id="modal-pumps" class="font-black text-3xl">${pumps}</span>
                                <button onclick="changeModalPumps(1)" class="w-12 h-12 bg-[#432818] text-[#E2CB9F] rounded-xl shadow-lg flex items-center justify-center"><i data-lucide="plus" class="w-5 h-5"></i></button>
                            </div>
                        </div>` : ''}
                    <div>
                         <label class="text-xs font-black opacity-50 uppercase ml-1">Milk</label>
                         <div class="bg-[#432818]/10 p-1 rounded-2xl flex mt-1">
                            <button onclick="updateModalState('milk', 'Regular')" data-milk="Regular" class="milk-btn flex-1 py-4 rounded-xl text-sm font-black transition-all ${milk==='Regular'?'bg-[#432818] text-[#E2CB9F] shadow-lg':'opacity-50'}">Regular</button>
                            <button onclick="updateModalState('milk', 'Oat')" data-milk="Oat" class="milk-btn flex-1 py-4 rounded-xl text-sm font-black transition-all ${milk==='Oat'?'bg-[#432818] text-[#E2CB9F] shadow-lg':'opacity-50'}">Oat (+$1)</button>
                         </div>
                    </div>
                </div>` : ''}
            <button id="modal-add-btn" onclick="addToCartFromModal()" ${isDisabled ? 'disabled' : ''} class="w-full bg-[#432818] text-[#E2CB9F] py-5 rounded-2xl font-black text-xl shadow-xl active:scale-95 transition-all ${isDisabled ? 'btn-disabled' : ''}">${isDisabled ? 'Select Flavor' : 'Add to Order'}</button>
        </div>`;
      lucide.createIcons();
  }

  init();
</script>
</body>
</html>
